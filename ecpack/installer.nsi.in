%import os.path
; Generated by ecpack-nsis.
Unicode True
!define SRC_DIR "%os.path.abspath(self.prefix)%"

; Use the modern user interface.
!include "MUI2.nsh"
%if self.file_exists("_cpack/NSIS/install.ico"):
    !define MUI_ICON "${SRC_DIR}\_cpack\NSIS\install.ico"
    %if self.file_exists("_cpack/NSIS/uninstall.ico"):
        !define MUI_UNIICON "${SRC_DIR}\_cpack\NSIS\uninstall.ico"
    %end
%end

%if self.file_exists("_cpack/NSIS/install_header.bmp"):
    !define MUI_HEADERIMAGE
    !define MUI_HEADERIMAGE_BITMAP "${SRC_DIR}\_cpack\NSIS\install_header.bmp"
    %if self.file_exists("_cpack/NSIS/uninstall_header.bmp"):
        '!define MUI_HEADERIMAGE_UNBITMAP "${SRC_DIR}\_cpack\NSIS\uninstall_header.bmp"
    %end
%end

; General config.
Name "%self.display_name%"
!ifdef CREATE_UNINSTALLER
    OutFile "%self.create_uninstaller_exe_filename()%"
!endif
!ifndef CREATE_UNINSTALLER
    OutFile "%self.install_exe_filename()%"
!endif

InstallDir "$PROGRAMFILES64\%self.vendor%\%self.display_name%"
InstallDirRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\%self.display_name%" "InstallLocation"

%if self.file_exists("_cpack/license.rtf"):
!insertmacro MUI_PAGE_LICENSE "${SRC_DIR}\_cpack\license.rtf"
%elif self.file_exists("_cpack/license.txt"):
!insertmacro MUI_PAGE_LICENSE "${SRC_DIR}\_cpack\license.txt"
%end

%if len(self.components) > 1:
!insertmacro MUI_PAGE_COMPONENTS
%end

!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

; Languages.
!insertmacro MUI_LANGUAGE "English"

Section "Core"
    SetOutPath "$INSTDIR"
!ifndef CREATE_UNINSTALLER
    File "uninstall.exe"
!endif
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\%self.display_name%" "InstallLocation" "$INSTDIR"
SectionEnd

; Recipe to uninstall the application
Section "Uninstall"
%directory_names = set()
%for component in self.components.values():
    %for file_name in component.file_names:
        %directory_names.add(os.path.dirname(file_name))
    Delete "$INSTDIR\%os.path.normcase(file_name)%"
    %end
%end

%for directory_name in directory_names:
    RMDir "$INSTDIR\%os.path.normcase(directory_name)%"
%end

    Delete "$INSTDIR\uninstall.exe"
    RMDir "$INSTDIR"
    DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\%self.display_name%"
SectionEnd

; Write the uninstaller because we need to sign it.
; .inInit is ignored by the uninstall.exe
Function .onInit
!ifdef CREATE_UNINSTALLER
    WriteUninstaller "%self.uninstall_exe_filename()%"
    Quit
!endif
FunctionEnd
